{% extends 'base.html' %}

{% block content %}
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'css/main.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/order_detail.css' %}">

<div class="container py-5">
    <div class="row">

        <!-- Main Order Section -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Order #{{ order.id }}</h4>
                    <span class="badge badge-{{ order.status|lower }} fs-6">{{ order.get_status_display }}</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-borderless">
                            <thead class="table-light">
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in order.items.all %}
                                <tr>
                                    <td>
                                    <div class="d-flex align-items-center">
                                        {% if item.product.image %}
                                            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;">
                                        {% endif %}
                                        <div>
                                            <h6 class="mb-0">{{ item.product.name }}</h6>
                                            <small class="text-muted">{{ item.product.description|truncatewords:5 }}</small>

                                            {% if item.selected_features %}
                                                <ul class="list-unstyled mb-1 small text-muted ps-1" style="font-size: 0.85rem;">
                                                    {% for key, value in item.selected_features.items %}
                                                        <li>
                                                            <span class="badge bg-light text-dark border">
                                                                <strong>{{ key|title }}:</strong> {{ value }}
                                                            </span>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                    <td>{{ item.quantity }}</td>
                                    <td>D{{ item.product.price|floatformat:2 }}</td>
                                    <td><strong>D{{ item.get_total_price|floatformat:2 }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Order Details Card -->
            <div class="card mb-4">
                <div class="card-body row">
                    <div class="col-md-6">
                        <p><strong>Order Date:</strong> {{ order.created_at|date:"F d, Y" }}</p>
                        <p><strong>Expected Delivery:</strong> {{ order.expected_delivery_date|date:"F d, Y"|default:"TBD" }}</p>
                        {% if order.promo_code %}
                            <p><strong>Promo Code:</strong> <span class="badge bg-success">{{ order.promo_code.code }}</span> <small class="text-muted">({{ order.promo_code.discount_percentage }}% off)</small></p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if order.shipping_address %}
                            <p><strong>Shipping Address:</strong></p>
                            <address class="small">
                                {{ order.shipping_address.street }}<br>
                                {{ order.shipping_address.city }}, {{ order.shipping_address.state }} {{ order.shipping_address.zip_code }}
                            </address>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>Chat with Supplier
                    </h5>
                    <small class="text-muted">Order #{{ order.id }}</small>
                </div>
                <div class="card-body p-0">
                    <!-- Chat Messages -->
                    <div id="chatMessages" class="chat-messages p-3" style="height: 400px; overflow-y: auto; border-bottom: 1px solid #dee2e6;">
                        {% if chat_messages %}
                            {% for message in chat_messages %}
                                <div class="message mb-3 {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                                    <div class="message-content">
                                        <div class="message-bubble {% if message.sender == request.user %}bg-primary text-white ms-auto{% else %}bg-light{% endif %} p-3 rounded">
                                            <p class="mb-1">{{ message.content }}</p>
                                            <small class="{% if message.sender == request.user %}text-white-50{% else %}text-muted{% endif %}">
                                                {{ message.created_at|date:"M d, Y H:i" }}
                                            </small>
                                        </div>
                                        <div class="message-sender mt-1 {% if message.sender == request.user %}text-end{% endif %}">
                                            <small class="text-muted">
                                                {% if message.sender == request.user %}
                                                    You
                                                {% else %}
                                                    {{ message.sender.first_name|default:message.sender.username }}
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-comments fa-3x mb-3"></i>
                                <p>No messages yet. Start a conversation with your supplier!</p>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Chat Input -->
                    <div class="chat-input p-3">
                        <form id="chatForm" class="d-flex">
                            {% csrf_token %}
                            <input type="hidden" name="order_id" value="{{ order.id }}">
                            <div class="flex-grow-1 me-3">
                                <textarea
                                    class="form-control"
                                    name="message"
                                    id="chatMessage"
                                    placeholder="Type your message about this order..."
                                    rows="2"
                                    required
                                ></textarea>
                            </div>
                            <div class="d-flex flex-column">
                                <button type="submit" class="btn btn-primary h-100" id="sendMessageBtn">
                                    <i class="fas fa-paper-plane"></i>
                                    <span class="d-none d-sm-inline ms-1">Send</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary & Actions Section -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Order Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span>D{{ order.get_subtotal|floatformat:2 }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Shipping:</span>
                        <span>D{{ order.shipping_cost|floatformat:2|default:"0.00" }}</span>
                    </div>
                    {% if order.promo_code and order.discount_amount %}
                        <div class="d-flex justify-content-between mb-2 text-success">
                            <span><i class="fas fa-tag me-1"></i> Promo Discount:</span>
                            <span>-D{{ order.discount_amount|floatformat:2 }}</span>
                        </div>
                    {% endif %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tax ({{ order.tax_rate|floatformat:1 }}%):</span>
                        <span>D{{ order.get_tax_amount|floatformat:2 }}</span>
                    </div>
                    <hr>
                    {% if order.promo_code and order.discount_amount %}
                        <div class="d-flex justify-content-between mb-1 text-muted">
                            <small>Original Total:</small>
                            <small class="text-decoration-line-through">D{{ order.get_subtotal_with_tax_and_shipping|floatformat:2 }}</small>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <strong>Final Total:</strong>
                            <strong class="text-primary">D{{ order.get_total|floatformat:2 }}</strong>
                        </div>
                        <div class="alert alert-success py-2 mb-3">
                            <small><i class="fas fa-check-circle me-1"></i> You saved D{{ order.discount_amount|floatformat:2 }}!</small>
                        </div>
                    {% else %}
                        <div class="d-flex justify-content-between mb-3">
                            <strong>Total:</strong>
                            <strong class="text-primary">D{{ order.get_total|floatformat:2 }}</strong>
                        </div>
                    {% endif %}

                    <!-- Order Action Buttons -->
                    {% if order.status == 'pending' %}
                        <button class="btn btn-primary btn-lg w-100 mb-3" onclick="proceedToPayment({{ order.id }})">
                            <i class="fas fa-credit-card me-2"></i> Proceed to Payment
                        </button>
                        <button class="btn btn-outline-danger w-100 mb-3" onclick="cancelOrder({{ order.id }})">
                            <i class="fas fa-times me-2"></i> Cancel Order
                        </button>

                    {% elif order.status == 'processing' %}
                        <button class="btn btn-info btn-lg w-100 mb-3" disabled>
                            <i class="fas fa-clock me-2"></i> Processing Order
                        </button>
                        <button class="btn btn-outline-danger w-100 mb-3" onclick="cancelOrder({{ order.id }})">
                            <i class="fas fa-times me-2"></i> Cancel Order
                        </button>
                    {% elif order.status == 'shipped' %}
                        <button class="btn btn-success btn-lg w-100 mb-3" onclick="trackOrder({{ order.id }})">
                            <i class="fas fa-truck me-2"></i> Track Order
                        </button>
                    {% elif order.status == 'delivered' %}
                        <button class="btn btn-outline-primary btn-lg w-100 mb-3" onclick="reorderItems({{ order.id }})">
                            <i class="fas fa-redo me-2"></i> Reorder Items
                        </button>
                    {% elif order.status == 'cancelled' %}
                        <div class="alert alert-danger text-center mb-3">
                            <i class="fas fa-times-circle me-2"></i> This order has been cancelled
                        </div>
                        <button class="btn btn-outline-primary btn-lg w-100 mb-3" onclick="reorderItems({{ order.id }})">
                            <i class="fas fa-redo me-2"></i> Reorder Items
                        </button>
                    {% endif %}

                    <a href="{% url 'marketplace:all_products' %}" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-shopping-bag me-2"></i> Continue Shopping
                    </a>
                </div>
            </div>

            <!-- Chat Status Card -->
            <div class="card mb-4">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-headset fa-2x text-primary"></i>
                    </div>
                    <h6>Need Help?</h6>
                    <p class="text-muted small mb-3">
                        Use the chat feature to communicate directly with your supplier about this order.
                    </p>
                    <div class="d-flex justify-content-center">
                        <span class="badge bg-success">
                            <i class="fas fa-circle me-1" style="font-size: 0.5rem;"></i>
                            Support Available
                        </span>
                    </div>
                </div>
            </div>

            <!-- Other Orders -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Your Other Orders</h5>
                </div>
                <div class="card-body">
                    {% if other_orders %}
                        <div class="list-group list-group-flush">
                            {% for other_order in other_orders %}
                                <div class="list-group-item px-0 py-2">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="mb-1">Order #{{ other_order.id }}</h6>
                                            <small class="text-muted">{{ other_order.created_at|date:"M d, Y" }}</small>
                                            {% if other_order.promo_code %}
                                                <br><span class="badge bg-success">{{ other_order.promo_code.code }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="text-end">
                                            <span class="badge badge-{{ other_order.status|lower }} mb-1">{{ other_order.get_status_display }}</span>
                                            <br><small class="text-muted">D{{ other_order.get_total|floatformat:2 }}</small>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <a href="{% url 'orders:order_detail' other_order.id %}" class="btn btn-sm btn-outline-primary me-2">View</a>
                                        {% if other_order.status == 'pending' %}
                                            <a href="{% url 'orders:complete_order' other_order.id %}" class="btn btn-sm btn-primary">Complete</a>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="mt-3">
                            <a href="{% url 'orders:order_history' %}" class="btn btn-outline-secondary btn-sm w-100">View All Orders</a>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">No other orders found.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="paymentForm" novalidate>
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Complete Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <select class="form-select" name="payment_method" id="paymentMethod" required>
                            <option value="">Select payment method</option>
                            <option value="wave">Wave</option>
                            <option value="qmoney">Qmoney</option>
                            <option value="afrimoney">Afrimoney</option>
                            <option value="cash">Cash Payment</option>
                            <option value="verve_card">Verve Card</option>
                        </select>
                    </div>

                    <div id="mobilePaymentFields" class="d-none">
                        <div class="mb-3">
                            <label class="form-label">Mobile Number</label>
                            <input type="text" class="form-control" name="mobile_number" placeholder="Enter your number">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">PIN</label>
                            <input type="password" class="form-control" name="pin" placeholder="Enter your PIN">
                        </div>
                    </div>

                    <div id="verveCardFields" class="d-none">
                        <div class="mb-3">
                            <label class="form-label">Card Number</label>
                            <input type="text" class="form-control" name="card_number" placeholder="1234 5678 9012 3456">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Expiry Date</label>
                                <input type="text" class="form-control" name="card_expiry" placeholder="MM/YY">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">CVV</label>
                                <input type="text" class="form-control" name="card_cvv" placeholder="123">
                            </div>
                        </div>
                    </div>

                    <div id="cashNote" class="alert alert-info d-none">
                        You selected cash payment. Please prepare the exact amount upon delivery.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="processPayment({{ order.id }})">
                        Pay D{{ order.get_total|floatformat:2 }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Cancel Order Modal -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i> Cancel Order
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>Warning:</strong> Cancelling this order will restore product stock and cannot be undone.
                </div>
                <p>Are you sure you want to cancel Order #{{ order.id }}?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Keep Order
                </button>
                <button type="button" class="btn btn-danger" id="confirmCancelBtn" onclick="confirmCancelOrder()">
                    Yes, Cancel Order
                </button>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'js/main.js' %}"></script>
<script src="{% static 'js/order_detail.js' %}"></script>

<script>
// Chat functionality
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chatForm');
    const chatMessages = document.getElementById('chatMessages');
    const chatMessage = document.getElementById('chatMessage');
    const sendMessageBtn = document.getElementById('sendMessageBtn');

    // Auto-scroll to bottom of chat
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Initialize scroll position
    scrollToBottom();

    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const messageText = chatMessage.value.trim();
        if (!messageText) return;

        // Disable send button
        sendMessageBtn.disabled = true;
        sendMessageBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        // Create FormData
        const formData = new FormData(chatForm);

        // Send message via AJAX
        fetch('{% url "orders:send_chat_message" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add message to chat
                const messageHtml = `
                    <div class="message mb-3 sent">
                        <div class="message-content">
                            <div class="message-bubble bg-primary text-white ms-auto p-3 rounded">
                                <p class="mb-1">${messageText}</p>
                                <small class="text-white-50">Just now</small>
                            </div>
                            <div class="message-sender mt-1 text-end">
                                <small class="text-muted">You</small>
                            </div>
                        </div>
                    </div>
                `;

                // If no messages before, remove the empty state
                const emptyState = chatMessages.querySelector('.text-center.text-muted.py-5');
                if (emptyState) {
                    emptyState.remove();
                }

                chatMessages.insertAdjacentHTML('beforeend', messageHtml);
                chatMessage.value = '';
                scrollToBottom();
            } else {
                alert('Failed to send message. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        })
        .finally(() => {
            // Re-enable send button
            sendMessageBtn.disabled = false;
            sendMessageBtn.innerHTML = '<i class="fas fa-paper-plane"></i><span class="d-none d-sm-inline ms-1">Send</span>';
        });
    });

    // Handle Enter key in textarea
    chatMessage.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.dispatchEvent(new Event('submit'));
        }
    });

    // Auto-resize textarea
    chatMessage.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
});
</script>
<script>
let lastMessageIds = new Set();

function refreshChatMessages() {
    fetch("{% url 'orders:fetch_chat_messages' order.id %}", {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const chatMessages = document.getElementById('chatMessages');

            // Only add new messages not already in DOM
            data.messages.forEach(msg => {
                if (!lastMessageIds.has(msg.id)) {
                    const msgDiv = document.createElement('div');
                    msgDiv.classList.add('message', 'mb-3');
                    msgDiv.classList.add(msg.is_self ? 'sent' : 'received');

                    msgDiv.innerHTML = `
                        <div class="message-content">
                            <div class="message-bubble ${msg.is_self ? 'bg-primary text-white ms-auto' : 'bg-light'} p-3 rounded">
                                <p class="mb-1">${msg.content}</p>
                                <small class="${msg.is_self ? 'text-white-50' : 'text-muted'}">${msg.timestamp}</small>
                            </div>
                            <div class="message-sender mt-1 ${msg.is_self ? 'text-end' : ''}">
                                <small class="text-muted">${msg.is_self ? 'You' : msg.sender_name}</small>
                            </div>
                        </div>
                    `;

                    chatMessages.appendChild(msgDiv);
                    lastMessageIds.add(msg.id);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            });
        }
    });
}

// Start polling every 5 seconds
setInterval(refreshChatMessages, 5000);
</script>

{% endblock %}