{% extends 'base.html' %}
{% load static %}

{% block title %}{{ store.name }} - Store{% endblock %}

{% block extra_head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<meta name="description" content="{{ store.short_description|default:'Discover amazing products at '|add:store.name }}">
<meta property="og:title" content="{{ store.name }} - Store">
<meta property="og:description" content="{{ store.short_description|default:'Discover amazing products' }}">
<meta property="og:image" content="{{ store.banner.url|default:store.logo.url }}">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
{% endblock %}

{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'css/main.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/store.css' %}">

<!-- Wrap everything in store-page class to scope CSS -->
<div class="store-page">

<!-- Store Header Section -->
<header class="store-header" role="banner">
  <div class="store-banner-container">
    {% if store.banner %}
    <div class="store-banner position-relative">
      <picture>
        <source media="(max-width: 768px)" srcset="{{ store.banner.url }}?w=768">
        <source media="(max-width: 1200px)" srcset="{{ store.banner.url }}?w=1200">
        <img src="{{ store.banner.url }}" alt="{{ store.name }} store banner" class="banner-image" loading="eager">
      </picture>
      <div class="banner-overlay" aria-hidden="true"></div>
    </div>
    {% else %}
    <div class="store-banner-placeholder" aria-label="Store banner placeholder">
      <div class="placeholder-content">
        <i class="fas fa-store" aria-hidden="true"></i>
        <span class="visually-hidden">{{ store.name }} store</span>
      </div>
    </div>
    {% endif %}

    <!-- Store Information Overlay -->
    <div class="store-info-overlay">
      <div class="container">
        <div class="row align-items-end">
          <div class="col-lg-8">
            <div class="store-identity">
              <div class="store-logo-container">
                {% if store.logo %}
                <img src="{{ store.logo.url }}" alt="{{ store.name }} logo" class="store-logo" loading="eager">
                {% else %}
                <div class="store-logo store-logo-placeholder" aria-label="Store logo placeholder">
                  <i class="fas fa-store" aria-hidden="true"></i>
                </div>
                {% endif %}
              </div>

              <div class="store-details">
                <h1 class="store-name">{{ store.name }}</h1>
                {% if store.short_description %}
                <p class="store-tagline">{{ store.short_description }}</p>
                {% endif %}

                <div class="store-meta">
                  <span class="meta-item">
                    <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                    <span>{{ store.city }}, {{ store.country }}</span>
                  </span>
                  <span class="meta-item">
                    <i class="fas fa-calendar" aria-hidden="true"></i>
                    <span>Since {{ store.created_at|date:"Y" }}</span>
                  </span>
                  <span class="meta-item">
                    <i class="fas fa-star" aria-hidden="true"></i>
                    <span>{{ average_rating|floatformat:1|default:"New" }} {% if review_count %}({{ review_count }} reviews){% endif %}</span>
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="store-actions">
              <button class="btn btn-outline-light btn-follow" onclick="toggleFavorite()" aria-label="Follow store">
                <i class="fas fa-heart" id="favoriteIcon" aria-hidden="true"></i>
                <span class="btn-text">Follow</span>
              </button>
              <button class="btn btn-primary btn-contact" data-bs-toggle="modal" data-bs-target="#contactModal" aria-label="Contact store">
                <i class="fas fa-envelope" aria-hidden="true"></i>
                <span class="btn-text">Contact</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- Store Navigation -->
<nav class="store-navigation" role="navigation" aria-label="Store sections">
  <div class="container">
    <ul class="nav nav-pills" id="storeNav" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link active" href="#products" data-section="products" role="tab" aria-selected="true">
          <i class="fas fa-box" aria-hidden="true"></i>
          <span>Products</span>
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="#about" data-section="about" role="tab" aria-selected="false">
          <i class="fas fa-info-circle" aria-hidden="true"></i>
          <span>About</span>
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="#reviews" data-section="reviews" role="tab" aria-selected="false">
          <i class="fas fa-star" aria-hidden="true"></i>
          <span>Reviews</span>
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" href="#contact" data-section="contact" role="tab" aria-selected="false">
          <i class="fas fa-phone" aria-hidden="true"></i>
          <span>Contact</span>
        </a>
      </li>
    </ul>
  </div>
</nav>

<!-- Main Content -->
<main class="store-main">
  <div class="container">
    <div class="row">
      <div class="col-lg-9">

        <!-- Products Section -->
        <section id="products" class="store-section" aria-labelledby="products-heading">
          <header class="section-header">
            <h2 id="products-heading" class="section-title">
              <i class="fas fa-box text-primary" aria-hidden="true"></i>
              Our Products
            </h2>
            <div class="section-controls">
              <label for="sortProducts" class="visually-hidden">Sort products</label>
              <select class="form-select" id="sortProducts" aria-label="Sort products">
                <option value="newest">Newest First</option>
                <option value="price-low">Price: Low to High</option>
                <option value="price-high">Price: High to Low</option>
                <option value="popular">Most Popular</option>
              </select>
              <a href="{% url 'stores:store_products' store.slug %}" class="btn btn-outline-primary">
                <span>View All Products</span>
                <i class="fas fa-arrow-right" aria-hidden="true"></i>
              </a>
            </div>
          </header>

          {% if products %}
          <div class="products-grid" id="productsContainer" role="grid" aria-label="Products">
            {% for product in products %}
            <article class="product-card" role="gridcell">
              <div class="product-image-container">
                {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image" loading="lazy">
                {% else %}
                <div class="product-image product-image-placeholder" aria-label="Product image placeholder">
                  <i class="fas fa-image" aria-hidden="true"></i>
                </div>
                {% endif %}

                <!-- Product Badges -->
                <div class="product-badges" aria-label="Product badges">
                  {% if product.is_new %}
                  <span class="badge badge-new">New</span>
                  {% endif %}
                  {% if product.is_featured %}
                  <span class="badge badge-featured">Featured</span>
                  {% endif %}
                  {% if product.discount_percentage %}
                  <span class="badge badge-discount">{{ product.discount_percentage }}% OFF</span>
                  {% endif %}
                </div>

                <!-- Quick Actions -->
                <div class="product-actions">
                  <button class="btn btn-action" title="Add to wishlist" aria-label="Add {{ product.name }} to wishlist">
                    <i class="fas fa-heart" aria-hidden="true"></i>
                  </button>
                  <button class="btn btn-action" title="Quick view" aria-label="Quick view of {{ product.name }}"
                          onclick="quickView({{ product.id }})">
                    <i class="fas fa-eye" aria-hidden="true"></i>
                  </button>

                </div>

                <!-- Stock Status -->
                {% if not product.is_in_stock %}
                <div class="stock-status out-of-stock" aria-label="Out of stock">
                  <span>Out of Stock</span>
                </div>
                {% endif %}
              </div>

              <div class="product-info">
                <h3 class="product-name">
                  <a href="#" class="product-link">{{ product.name|truncatechars:50 }}</a>
                </h3>

                <div class="product-pricing">
                  <span class="price-current">D{{ product.price }}</span>
                  {% if product.original_price %}
                  <span class="price-original">D{{ product.original_price }}</span>
                  {% endif %}
                </div>

                <div class="product-rating" aria-label="Product rating">
                  <div class="stars" aria-label="{{ product.average_rating|floatformat:1 }} out of 5 stars">
                    {% for i in "12345" %}
                      {% if forloop.counter <= product.average_rating %}
                        <i class="fas fa-star" aria-hidden="true"></i>
                      {% else %}
                        <i class="far fa-star" aria-hidden="true"></i>
                      {% endif %}
                    {% endfor %}
                  </div>
                  <span class="rating-count">({{ product.review_count|default:0 }})</span>
                </div>

                {% if product.free_shipping %}
                <div class="shipping-info">
                  <i class="fas fa-shipping-fast" aria-hidden="true"></i>
                  <span>Free Shipping</span>
                </div>
                {% endif %}

                <div class="product-action">
                  {% if product.is_in_stock %}
                  <button class="btn btn-primary btn-add-cart" onclick="addToCart({{ product.id }})" aria-label="Add {{ product.name }} to cart">
                    <i class="fas fa-shopping-cart" aria-hidden="true"></i>
                    <span>Add to Cart</span>
                  </button>
                  {% else %}
                  <button class="btn btn-secondary" disabled aria-label="Out of stock">
                    <i class="fas fa-times" aria-hidden="true"></i>
                    <span>Out of Stock</span>
                  </button>
                  {% endif %}
                </div>
              </div>
            </article>
            {% endfor %}
          </div>
          {% else %}
          <div class="empty-state" role="status" aria-label="No products available">
            <i class="fas fa-box" aria-hidden="true"></i>
            <h3>No products available</h3>
            <p>This store hasn't added any products yet.</p>
          </div>
          {% endif %}
        </section>

        <!-- About Section -->
        <section id="about" class="store-section" aria-labelledby="about-heading">
          <h2 id="about-heading" class="section-title">
            <i class="fas fa-info-circle text-primary" aria-hidden="true"></i>
            About Our Store
          </h2>

          <div class="row">
            <div class="col-md-8">
              <div class="store-description">
                {% if store.description %}
                <p class="lead">{{ store.description|linebreaks }}</p>
                {% else %}
                <p class="text-muted">No store description available.</p>
                {% endif %}
              </div>

              <div class="store-features">
                <h3>Why Shop With Us?</h3>
                <div class="features-grid">
                  <div class="feature-item">
                    <i class="fas fa-shield-alt" aria-hidden="true"></i>
                    <span>Secure Shopping</span>
                  </div>
                  <div class="feature-item">
                    <i class="fas fa-truck" aria-hidden="true"></i>
                    <span>Fast Delivery</span>
                  </div>
                  <div class="feature-item">
                    <i class="fas fa-undo" aria-hidden="true"></i>
                    <span>Easy Returns</span>
                  </div>
                  <div class="feature-item">
                    <i class="fas fa-headset" aria-hidden="true"></i>
                    <span>24/7 Support</span>
                  </div>
                  <div class="feature-item">
                    <i class="fas fa-medal" aria-hidden="true"></i>
                    <span>Quality Guarantee</span>
                  </div>
                  <div class="feature-item">
                    <i class="fas fa-credit-card" aria-hidden="true"></i>
                    <span>Secure Payments</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="store-stats-card">
                <h4>Store Stats</h4>
                <div class="stats-grid">
                  <div class="stat-item">
                    <div class="stat-number">{{ products.count|default:0 }}</div>
                    <div class="stat-label">Products</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-number">{{ review_count|default:0 }}</div>
                    <div class="stat-label">Reviews</div>
                  </div>
                  <div class="stat-item stat-rating">
                    <div class="stat-number">{{ average_rating|floatformat:1|default:"0.0" }}/5</div>
                    <div class="stat-label">Average Rating</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Reviews Section -->
        <section id="reviews" class="store-section" aria-labelledby="reviews-heading">
          <h2 id="reviews-heading" class="section-title">
            <i class="fas fa-star text-primary" aria-hidden="true"></i>
            Customer Reviews
          </h2>

          <div class="reviews-overview">
            <div class="rating-summary">
              <div class="overall-rating">
                <div class="rating-number">{{ average_rating|floatformat:1|default:"0.0" }}</div>
                <div class="rating-stars" aria-label="{{ average_rating|floatformat:1|default:'0' }} out of 5 stars">
                  {% for i in "12345" %}
                    {% if forloop.counter <= average_rating|floatformat:0 %}
                      <i class="fas fa-star" aria-hidden="true"></i>
                    {% elif average_rating|floatformat:1 > forloop.counter0 and average_rating|floatformat:1 < forloop.counter %}
                      <i class="fas fa-star-half-alt" aria-hidden="true"></i>
                    {% else %}
                      <i class="far fa-star" aria-hidden="true"></i>
                    {% endif %}
                  {% endfor %}
                </div>
                <p class="rating-text">Based on {{ review_count|default:0 }} reviews</p>
              </div>
            </div>

            <div class="rating-breakdown">
              {% for star in "54321" %}
                {% with count=rating_breakdown.star|default:0 %}
                  {% if review_count > 0 %}
                    {% widthratio count review_count 100 as percent %}
                  {% else %}
                    {% widthratio 0 1 100 as percent %}
                  {% endif %}
                  <div class="rating-bar" aria-label="{{ star }} star: {{ count }} reviews">
                    <span class="star-label">{{ star }} <i class="fas fa-star" aria-hidden="true"></i></span>
                    <div class="progress-bar-container">
                      <div class="progress-bar" style="width: {{ percent }}%"></div>
                    </div>
                    <span class="count-label">{{ count }}</span>
                  </div>
                {% endwith %}
              {% endfor %}
            </div>
          </div>

          <div class="reviews-list">
            {% for review in recent_reviews %}
            <article class="review-card">
              <header class="review-header">
                <div class="reviewer-info">
                  <div class="reviewer-avatar">
                    <span>{{ review.user.first_name|default:"C"|slice:":1" }}</span>
                  </div>
                  <div class="reviewer-details">
                    <h4 class="reviewer-name">{{ review.user.get_full_name|default:"Customer" }}</h4>
                    <span class="verified-badge">Verified Purchase</span>
                  </div>
                </div>
                <div class="review-meta">
                  <div class="review-rating" aria-label="{{ review.rating }} out of 5 stars">
                    {% for i in "12345" %}
                      {% if forloop.counter <= review.rating %}
                        <i class="fas fa-star" aria-hidden="true"></i>
                      {% else %}
                        <i class="far fa-star" aria-hidden="true"></i>
                      {% endif %}
                    {% endfor %}
                  </div>
                  <time class="review-date" datetime="{{ review.created_at|date:'c' }}">
                    {{ review.created_at|timesince }} ago
                  </time>
                </div>
              </header>
              <div class="review-content">
                <p>{{ review.comment|default:"No comment provided." }}</p>
              </div>
            </article>
            {% empty %}
            <div class="empty-state" role="status">
              <i class="fas fa-star" aria-hidden="true"></i>
              <h3>No reviews yet</h3>
              <p>Be the first to review this store!</p>
            </div>
            {% endfor %}
          </div>
        </section>
      </div>

      <!-- Sidebar -->
      <aside class="col-lg-3" role="complementary">
        <div class="sidebar-sticky">

          <!-- Contact Card -->
          <div class="sidebar-card" id="contact">
            <h3 class="sidebar-title">
              <i class="fas fa-phone text-primary" aria-hidden="true"></i>
              Contact Store
            </h3>
            <div class="contact-info">
              {% if store.phone %}
              <div class="contact-item">
                <i class="fas fa-phone" aria-hidden="true"></i>
                <a href="tel:{{ store.phone }}">{{ store.phone }}</a>
              </div>
              {% endif %}

              <div class="contact-item">
                <i class="fas fa-envelope" aria-hidden="true"></i>
                <a href="mailto:{{ store.email }}">{{ store.email }}</a>
              </div>

              <div class="contact-item">
                <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                <address>
                  {{ store.address_line_1 }}<br>
                  {% if store.address_line_2 %}{{ store.address_line_2 }}<br>{% endif %}
                  {{ store.city }}, {{ store.region }}<br>
                  {{ store.country }} {{ store.postal_code }}
                </address>
              </div>

              {% if store.website %}
              <div class="contact-item">
                <i class="fas fa-globe" aria-hidden="true"></i>
                <a href="{{ store.website }}" target="_blank" rel="noopener noreferrer">
                  Visit Website
                  <i class="fas fa-external-link-alt" aria-hidden="true"></i>
                </a>
              </div>
              {% endif %}
            </div>

            <button class="btn btn-primary btn-block" data-bs-toggle="modal" data-bs-target="#contactModal">
              <i class="fas fa-envelope" aria-hidden="true"></i>
              <span>Send Message</span>
            </button>
          </div>

          <!-- Categories -->
          <div class="sidebar-card">
            <h3 class="sidebar-title">
              <i class="fas fa-tags text-primary" aria-hidden="true"></i>
              Categories
            </h3>
            <nav class="category-nav" aria-label="Product categories">
              {% for category in categories %}
                <a href="{% url 'marketplace:category_detail' category.id %}" class="category-link">
                  {{ category.name }} <span class="count">({{ category.product_count }})</span>
                </a>
              {% empty %}
                <p class="text-muted">No categories available for this store.</p>
              {% endfor %}
            </nav>
          </div>

          <!-- Social Media -->
          <div class="sidebar-card">
            <h3 class="sidebar-title">
              <i class="fas fa-share-alt text-primary" aria-hidden="true"></i>
              Follow Us
            </h3>
            <div class="social-links">
              {% if store.facebook_url %}
              <a href="{{ store.facebook_url }}" class="social-link facebook" target="_blank" rel="noopener noreferrer" aria-label="Follow on Facebook">
                <i class="fab fa-facebook" aria-hidden="true"></i>
              </a>
              {% endif %}
              {% if store.twitter_url %}
              <a href="{{ store.twitter_url }}" class="social-link twitter" target="_blank" rel="noopener noreferrer" aria-label="Follow on Twitter">
                <i class="fab fa-twitter" aria-hidden="true"></i>
              </a>
              {% endif %}
              {% if store.instagram_url %}
              <a href="{{ store.instagram_url }}" class="social-link instagram" target="_blank" rel="noopener noreferrer" aria-label="Follow on Instagram">
                <i class="fab fa-instagram" aria-hidden="true"></i>
              </a>
              {% endif %}
            </div>

            <button class="btn btn-outline-primary btn-block" onclick="shareStore()">
              <i class="fas fa-share" aria-hidden="true"></i>
              <span>Share Store</span>
            </button>
          </div>
        </div>
      </aside>
    </div>
  </div>
</main>

<!-- Contact Modal -->
<div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="contactModalLabel">Contact {{ store.name }}</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="contactForm" novalidate>
          <div class="mb-3">
            <label for="contactName" class="form-label">Your Name <span class="required">*</span></label>
            <input type="text" class="form-control" id="contactName" name="name" required>
            <div class="invalid-feedback">Please provide your name.</div>
          </div>
          <div class="mb-3">
            <label for="contactEmail" class="form-label">Email <span class="required">*</span></label>
            <input type="email" class="form-control" id="contactEmail" name="email" required>
            <div class="invalid-feedback">Please provide a valid email address.</div>
          </div>
          <div class="mb-3">
            <label for="contactSubject" class="form-label">Subject <span class="required">*</span></label>
            <input type="text" class="form-control" id="contactSubject" name="subject" required>
            <div class="invalid-feedback">Please provide a subject.</div>
          </div>
          <div class="mb-3">
            <label for="contactMessage" class="form-label">Message <span class="required">*</span></label>
            <textarea class="form-control" id="contactMessage" name="message" rows="4" required></textarea>
            <div class="invalid-feedback">Please provide a message.</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary" form="contactForm">Send Message</button>
      </div>
    </div>
  </div>
</div>



<!-- Loading Spinner -->
<div id="loadingSpinner" class="loading-spinner" aria-hidden="true" role="status">
  <div class="spinner"></div>
  <span class="visually-hidden">Loading...</span>
</div>

<!-- Success Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <i class="fas fa-check-circle text-success me-2" aria-hidden="true"></i>
      <strong class="me-auto">Success</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      <!-- Message will be inserted here -->
    </div>
  </div>
</div>

<script src="{% static 'js/main.js' %}"></script>
<script src="{% static 'js/store-page-manager.js' %}" defer></script>

{% endblock %}